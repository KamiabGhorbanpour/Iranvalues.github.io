<head>
  <link href="https://fonts.googleapis.com/css?family=Montserrat:300,400,700|Roboto:400,700" rel="stylesheet">
  <link href='style.css' rel='stylesheet' type='text/css'>
  <title>Iranvalues Quiz</title>
  <link rel="icon" type="x-icon" href="icon.png">
  <link rel="shortcut icon" type="x-icon" href="icon.png">
  <meta charset="utf-8">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({
      google_ad_client: "ca-pub-6511426299019766",
      enable_page_level_ads: true
    });
  </script>
</head>

<body>

<!-- IMPORTANT: load axes BEFORE questions -->
<script type="application/javascript" src="axes.js"></script>
<script type="application/javascript" src="questions.js"></script>

<h1>Iranvalues</h1>
<hr>
<h2 style="text-align:center;" id="question-number">Loading...</h2>
<p class="question" id="question-text"></p>

<button class="button stronglyAgree" onclick="next_question( 1.0)">Strongly Agree</button> <br>
<button class="button agree" onclick="next_question( 0.5)">Agree</button> <br>
<button class="button neutral" onclick="next_question( 0.0)">Neutral/Unsure</button> <br>
<button class="button disagree" onclick="next_question(-0.5)">Disagree</button> <br>
<button class="button stronglyDisagree" onclick="next_question(-1.0)">Strongly Disagree</button> <br>

<button class="small_button" onclick="prev_question()" id="back_button">Back</button>
<button class="small_button_off" id="back_button_off">Back</button><br>

<!-- Website visit statistics - no personal information is collected! -->
<script type="text/javascript">
  var sc_project=11325211;
  var sc_invisible=1;
  var sc_security="fd9f0659";
  var scJsHost = (("https:" == document.location.protocol) ?
  "https://secure." : "http://www.");
  document.write("<sc"+"ript type='text/javascript' src='" +
  scJsHost+
  "statcounter.com/counter/counter.js'></"+"script>");
</script>
<noscript><div class="statcounter"><a title="web stats"
href="http://statcounter.com/" target="_blank"><img
class="statcounter"
src="//c.statcounter.com/11325211/0/fd9f0659/1/" alt="web
stats"></a></div></noscript>

<!-- JavaScript for the test itself -->
<script>
  // --- Safety checks ---
  if (typeof AXES === "undefined") {
    alert("AXES is not loaded. Make sure axes.js is included before questions.js.");
    throw new Error("AXES not loaded");
  }
  if (typeof questions === "undefined" || !Array.isArray(questions)) {
    alert("questions.js did not load correctly.");
    throw new Error("questions not loaded");
  }

  // --- Build score buckets for ALL keys from axes.js ---
  const scores = {};
  AXES.forEach(a => {
    scores[a.leftKey] = 0;
    scores[a.rightKey] = 0;
  });

  // --- Track per-question contributions so Back works correctly ---
  const contrib = new Array(questions.length); // each entry will be an object of key->delta

  var qn = 0; // Question number
  init_question();

  function init_question() {
    document.getElementById("question-text").innerHTML = questions[qn].question;
    document.getElementById("question-number").innerHTML = "Question " + (qn + 1) + " of " + (questions.length);

    if (qn === 0) {
      document.getElementById("back_button").style.display = 'none';
      document.getElementById("back_button_off").style.display = 'block';
    } else {
      document.getElementById("back_button").style.display = 'block';
      document.getElementById("back_button_off").style.display = 'none';
    }
  }

  function apply_effect(effectObj, mult) {
    // effectObj: { key: weight, ... }
    const delta = {};
    for (const k in effectObj) {
      // Ensure the key exists in scores; if not, create it (helps catch typos without crashing)
      if (scores[k] === undefined) scores[k] = 0;
      const change = (effectObj[k] || 0) * mult;
      scores[k] += change;
      delta[k] = change;
    }
    return delta;
  }

  function undo_effect(deltaObj) {
    if (!deltaObj) return;
    for (const k in deltaObj) {
      if (scores[k] === undefined) scores[k] = 0;
      scores[k] -= deltaObj[k];
    }
  }

  function next_question(mult) {
    // If user is re-answering this question (after going back), undo old contribution first.
    undo_effect(contrib[qn]);

    const effect = questions[qn].effect || {};
    contrib[qn] = apply_effect(effect, mult);

    qn++;
    if (qn < questions.length) {
      init_question();
    } else {
      results();
    }
  }

  function prev_question() {
    if (qn === 0) return;

    // Go back one question, and undo that question's contribution
    qn--;
    undo_effect(contrib[qn]);
    contrib[qn] = undefined;

    init_question();
  }

  function results() {
    // Store raw scores AND axes definitions so results.html can render dynamically
    localStorage.setItem("scores", JSON.stringify(scores));
    localStorage.setItem("axes", JSON.stringify(AXES));
    window.location.href = "results.html";
  }
</script>
</body>
