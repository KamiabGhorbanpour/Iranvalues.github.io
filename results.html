<!DOCTYPE html>
<html>
<head>
  <link href="https://fonts.googleapis.com/css?family=Montserrat:300,400,700|Roboto:400,700" rel="stylesheet">
  <link href="style.css" rel="stylesheet" type="text/css">
  <title>Iranvalues Results</title>
  <link rel="icon" type="x-icon" href="icon.png">
  <link rel="shortcut icon" type="x-icon" href="icon.png">
  <meta charset="utf-8">
</head>

<body>
  <h1>Iranvalues</h1>
  <hr>
  <h2 style="text-align:center;">Your Results</h2>

  <!-- ============================
       DOCTRINAL / MULTI-LAYER RESULT
       ============================ -->

  <div class="explanation_bg" style="margin-top: 20px;">
    <div class="spacer">
      <h2 style="text-align:center;">Doctrinal Result</h2>

      <p id="branch-title"
         style="text-align:center; font-size: 15pt; margin-bottom: 6px;"></p>

      <p id="branch-desc"
         style="text-align:center; opacity: 0.9; margin-top: 0;"></p>

      <p style="text-align:center; opacity: 0.8; font-size: 11.5pt; margin-top: 10px; line-height: 1.4;">
        Method note: This result is determined via <b>multi-layer branching</b>.
        You only see deeper layers (Leninism, MLM) if you first qualify for earlier layers (Marxism, tilt).
        Passing multiple layers is expected; the label shown reflects the <b>deepest layer reached</b>.
      </p>
    </div>
  </div>

  <!-- ============================
       AXIS RESULTS
       ============================ -->

  <div id="axes-results"></div>

  <p style="text-align:center; margin-top: 24px;">
    <a href="index.html">Take the quiz again</a>
  </p>

  <!-- ============================
       DEBUG PANEL (TEMPORARY)
       ============================ -->

  <div class="explanation_bg" style="margin-top: 30px;">
    <div class="spacer">
      <h2 style="text-align:center;">Debug (remove later)</h2>
      <pre id="debug-out"
           style="white-space: pre-wrap; font-size: 11pt;"></pre>
    </div>
  </div>

  <!-- ============================
       LOAD AXES
       ============================ -->

  <script src="axes.js"></script>

  <script>
    /* ============================
       READ STORED DATA
       ============================ */

    let scores = {};
    let flags = {};

    try {
      scores = JSON.parse(localStorage.getItem("scores") || "{}");
    } catch (e) {
      scores = {};
    }

    try {
      flags = JSON.parse(localStorage.getItem("flags") || "{}");
    } catch (e) {
      flags = {};
    }

    /* ============================
       NUMERIC FIX (CRITICAL)
       ============================ */

    function num(x) {
      const n = parseFloat(x);
      return Number.isFinite(n) ? n : 0;
    }

    /* ============================
       AXIS MATH
       ============================ */

    function rightPercent(leftKey, rightKey) {
      const L = num(scores[leftKey]);
      const R = num(scores[rightKey]);

      const denom = Math.abs(L) + Math.abs(R);
      if (denom === 0) return 50;

      const rpct = (Math.abs(R) / denom) * 100;
      const diff = R - L;

      return diff < 0 ? (100 - rpct) : rpct;
    }

    function axisBlock(axis) {
      const r = rightPercent(axis.leftKey, axis.rightKey);
      const l = 100 - r;

      return `
        <div class="axis">
          <div class="axis-title">${axis.title}</div>
          <div class="bar">
            <div class="bar-left" style="width:${l}%"></div>
            <div class="bar-right" style="width:${r}%"></div>
          </div>
          <div class="axis-labels">
            <span>${axis.leftLabel} (${l.toFixed(0)}%)</span>
            <span>${axis.rightLabel} (${r.toFixed(0)}%)</span>
          </div>
        </div>
      `;
    }

    /* ============================
       DOCTRINAL BRANCH LOGIC
       ============================ */

    function determineBranch(f) {
      if (!f || typeof f !== "object") {
        return { title: "Axis-based result only", desc: "No doctrinal branch reached." };
      }

      if (f.mlmQualified) {
        return {
          title: "Marxism–Leninism–Maoism (MLM)",
          desc: "You reached the deepest doctrinal layer used in this quiz."
        };
      }

      if (f.leninistEligible) {
        return {
          title: "Leninist Marxism",
          desc: "You qualified for party-centralist Marxism but not the MLM layer."
        };
      }

      if (f.authMarx === true) {
        return {
          title: "Authoritarian-leaning Marxism",
          desc: "You qualified for Marxism with a centralist tilt."
        };
      }

      if (f.authMarx === false) {
        return {
          title: "Democratic / pluralist Marxism",
          desc: "You qualified for Marxism with a pluralist tilt."
        };
      }

      if (f.marxEligible) {
        return {
          title: "Marxism (general)",
          desc: "You qualified for Marx-related questions only."
        };
      }

      return {
        title: "Axis-based result only",
        desc: "You did not enter any doctrinal branch."
      };
    }

    /* ============================
       RENDER DOCTRINAL RESULT
       ============================ */

    const branch = determineBranch(flags);
    document.getElementById("branch-title").textContent = branch.title;
    document.getElementById("branch-desc").textContent = branch.desc;

    /* ============================
       RENDER AXES
       ============================ */

    const root = document.getElementById("axes-results");

    if (typeof AXES === "undefined") {
      root.innerHTML = "<p style='text-align:center;'>AXES not loaded.</p>";
    } else {
      root.innerHTML = AXES.map(axisBlock).join("");
    }

    /* ============================
       DEBUG OUTPUT
       ============================ */

    const dbg = document.getElementById("debug-out");
    const scoreKeys = Object.keys(scores || {});
    const axesOk = (typeof AXES !== "undefined" && AXES.length);

    let debugText = "";
    debugText += "scores exists: " + (localStorage.getItem("scores") !== null) + "\n";
    debugText += "score key count: " + scoreKeys.length + "\n";
    debugText += "score keys: " + scoreKeys.join(", ") + "\n\n";

    debugText += "AXES loaded: " + axesOk + "\n";
    if (axesOk) {
      debugText += "AXES[0].leftKey: " + AXES[0].leftKey +
                   " → value: " + scores[AXES[0].leftKey] + "\n";
      debugText += "AXES[0].rightKey: " + AXES[0].rightKey +
                   " → value: " + scores[AXES[0].rightKey] + "\n";
    }

    dbg.textContent = debugText;
  </script>

  <!-- Minimal fallback styling -->
  <style>
    .axis { margin: 18px 0; }
    .axis-title { font-weight: 700; margin-bottom: 8px; }
    .bar { display:flex; height:18px; border-radius:10px; overflow:hidden; background:#eee; }
    .bar-left { background:#444; }
    .bar-right { background:#999; }
    .axis-labels { display:flex; justify-content:space-between; margin-top:6px; font-size:14px; }
  </style>

</body>
</html>
