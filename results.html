<!DOCTYPE html>
<html>
<head>
  <link href="https://fonts.googleapis.com/css?family=Montserrat:300,400,700|Roboto:400,700" rel="stylesheet">
  <link href="style.css" rel="stylesheet" type="text/css">
  <title>Iranvalues Results</title>
  <link rel="icon" type="x-icon" href="icon.png">
  <link rel="shortcut icon" type="x-icon" href="icon.png">
  <meta charset="utf-8">
</head>

<body>
  <h1>Iranvalues</h1>
  <hr>
  <h2 style="text-align:center;">Your Results</h2>

  <!-- RESULT HERO -->
  <div class="iv-card iv-hero">
    <div class="iv-hero__media">
      <img id="ideology-img"
           class="iv-logo"
           src="icon.png"
           alt="Ideology symbol"
           loading="lazy">
    </div>

    <div class="iv-hero__content">
      <div class="iv-kicker">Doctrinal Result</div>
      <h2 id="branch-title" class="iv-title"></h2>
      <p id="branch-desc" class="iv-desc"></p>

      <div class="iv-meta">
        <div class="iv-pill">
          <b>Multi-layer logic</b>
          <span id="layer-note"></span>
        </div>
      </div>
    </div>
  </div>

  <!-- CLOSE FIGURE -->
  <div class="iv-card iv-figure" id="figure-card">
    <div class="iv-figure__media">
      <img id="figure-img"
           src="icon.png"
           alt="Figure"
           loading="lazy">
    </div>

    <div class="iv-figure__content">
      <div class="iv-kicker">Close figure</div>
      <h3 id="figure-name" class="iv-subtitle"></h3>
      <p id="figure-desc" class="iv-desc"></p>
    </div>
  </div>

  <!-- AXES -->
  <div id="axes-results"></div>

  <p style="text-align:center; margin-top: 24px;">
    <a href="index.html">Take the quiz again</a>
  </p>

  <script src="axes.js"></script>

  <script>
    // ----------------------------
    // Read storage
    // ----------------------------
    let scores = {};
    let flags = {};
    try { scores = JSON.parse(localStorage.getItem("scores") || "{}"); } catch (e) { scores = {}; }
    try { flags  = JSON.parse(localStorage.getItem("flags")  || "{}"); } catch (e) { flags  = {}; }

    // ----------------------------
    // Helpers
    // ----------------------------
    function num(x) {
      const n = parseFloat(x);
      return Number.isFinite(n) ? n : 0;
    }

    function getScore(key) {
      if (!scores || typeof scores !== "object") return 0;
      if (Object.prototype.hasOwnProperty.call(scores, key)) return num(scores[key]);

      // tolerate -/_ mismatches
      const alt1 = key.replace(/-/g, "_");
      const alt2 = key.replace(/_/g, "-");
      if (Object.prototype.hasOwnProperty.call(scores, alt1)) return num(scores[alt1]);
      if (Object.prototype.hasOwnProperty.call(scores, alt2)) return num(scores[alt2]);
      return 0;
    }

    // robust 0..100 mapping using mirrored keys
    function rightPercent(leftKey, rightKey) {
      const L = getScore(leftKey);
      const R = getScore(rightKey);
      const denom = Math.abs(L) + Math.abs(R);
      if (denom === 0) return 50;
      const bias = (R - L) / denom; // -1..+1
      const rpct = 50 + 50 * bias;
      return Math.max(0, Math.min(100, rpct));
    }

    function axisBlock(axis) {
      const r = rightPercent(axis.leftKey, axis.rightKey);
      const l = 100 - r;

      return `
        <div class="axis">
          <div class="axis-title">${axis.title}</div>
          <div class="bar">
            <div class="bar-left" style="flex:0 0 ${l}%; width:${l}%;"></div>
            <div class="bar-right" style="flex:0 0 ${r}%; width:${r}%;"></div>
          </div>
          <div class="axis-labels">
            <span>${axis.leftLabel} (${l.toFixed(0)}%)</span>
            <span>${axis.rightLabel} (${r.toFixed(0)}%)</span>
          </div>
        </div>
      `;
    }

    // ----------------------------
    // Branch content (TEXT + IMAGES)
    // IMPORTANT: Ideology images will fall back to icon.png if missing.
    // ----------------------------
    function determineBranch(f) {
      const out = {
        key: "axisOnly",
        title: "Axis-based result only",
        desc: "You did not enter a doctrinal branch; your result reflects your value axes.",
        ideologyImg: "icon.png",
        ideologyAlt: "Ideology symbol",
        figureImg: "",
        figureAlt: "",
        figureName: "",
        figureDesc: "",
        layerNote: "Axes only"
      };

      // --------------------------
      // Democratic Socialism (NEW)
      // Put this early so it wins over generic Marx branches.
      // --------------------------
      if (f && f.demSocEligible === true) {
        out.key = "demsoc";
        out.title = "Democratic Socialism";
        out.desc =
          "Democratic socialism in Iran became especially visible in the 1950s and 1960s as a current that tried to combine social justice with political democracy and national independence. " +
          "It gained momentum in the era of the oil nationalization movement, where sovereignty over resources and mass democratic politics were often treated as part of the same struggle. " +
          "Within that broader nationalist atmosphere, the Toilers Party and adjacent circles helped popularize a language of “socialism without dictatorship”: anti-imperialist and socially egalitarian, but also skeptical of one-party rule and external patronage.";

        // Your torch/logo image (save as img/toilers-party.png)
        out.ideologyImg = "img/toilers-party.png";
        out.ideologyAlt = "Toilers Party / democratic socialist emblem";

        // Your Maleki portrait (save as img/khalil-maleki.jpg)
        out.figureImg = "img/khalil-maleki.jpg";
        out.figureAlt = "Khalil Maleki";
        out.figureName = "Khalil Maleki";
        out.figureDesc =
          "Khalil Maleki was one of the earliest major socialist leaders in Iran to reject Stalin’s model of “socialism” and the political culture built around it. " +
          "He argued that socialism must be compatible with democratic freedoms—pluralism, elections, an independent press, and unions—and that social transformation in Iran should be pursued through democratic and incremental change rather than a single decisive revolutionary rupture against the Shah. " +
          "In Iranian political memory, he is often associated with a “Third Force” tendency: socialist in economic outlook, nationalist in independence, and firmly opposed to authoritarianism—whether justified in the name of monarchy, religion, or party rule.";

        out.layerNote = "Marx core gate → pluralism track → DemSoc filter (+ circle-backs)";
        return out;
      }

      // MLM
      if (f && f.mlmQualified) {
        out.key = "mlm";
        out.title = "Marxism–Leninism–Maoism (MLM)";
        out.desc =
          "While Marxism–Leninism–Maoism never had huge momentum in Iranian society and political culture, it influenced a number of militants and produced small but organized parties. " +
          "Iranian Maoist currents broke with established pro-Soviet Marxist–Leninist organizations (above all the Tudeh Party), and their political identity was shaped by the Sino–Soviet split and the charge of “revisionism.” " +
          "Most of these parties ultimately functioned outside Iran, and many rejected Khomeini’s leadership in 1979 from the outset.";

        out.ideologyImg = "img/cpimlm-symbol.png";
        out.ideologyAlt = "Symbol associated with Iranian MLM currents";

        out.figureImg = "img/parviz-nikkhah.jpg";
        out.figureAlt = "Parviz Nikkhah";
        out.figureName = "Parviz Nikkhah";
        out.figureDesc =
          "Parviz Nikkhah is often remembered in Iranian political history through the arc of the 1960s–70s radical scene and the intense ideological fractures of the era. " +
          "He is a useful reference point for how Iranian leftists and anti-imperialist movements splintered over strategy, international alignments, and what counted as “revisionism,” long before the post-1979 diaspora reorganized many of these networks.";

        out.layerNote = "Marx gate → tilt → Lenin gate → MLM gate";
        return out;
      }

      // ML (Stalinism)
      if (f && f.leninistEligible && f.mlStalinEligible) {
        out.key = "ml_stalin";
        out.title = "Marxism–Leninism (Stalinism)";
        out.desc =
          "This result corresponds to the orthodox, Soviet-style Marxism–Leninism associated with the pre-1956 political and organizational model. " +
          "In Iran, this orientation was historically most visible through the Tudeh Party’s intellectual and organizational milieu: disciplined party structure, strategic emphasis on broad anti-imperialist alliances, and a staged conception of political transformation. " +
          "After 1956, the Soviet turn toward de-Stalinization and the broader reorientation of the international communist movement contributed to intensified splits and the rise of anti-revisionist currents.";

        out.ideologyImg = "img/ml-stalinism.png";
        out.ideologyAlt = "Marxism–Leninism (Stalinism) emblem";

        out.figureImg = "img/ehsan-tabari.jpg";
        out.figureAlt = "Ehsan Tabari";
        out.figureName = "Ehsan Tabari";
        out.figureDesc =
          "Ehsan Tabari (1917–1989) was among the most prominent Tudeh Party intellectuals and a major figure in its theoretical production. " +
          "He represents the tendency to defend the Stalin-era Soviet model and to treat post-1956 de-Stalinization and Khrushchev’s “Secret Speech” as lacking substantive value compared to the earlier orthodox line. ";

        out.layerNote = "Marx gate → tilt → Lenin gate → ML/Stalin split";
        return out;
      }

      // General ML (if Leninist-eligible but neither MLM nor the Stalin split)
      if (f && f.leninistEligible) {
        out.key = "ml";
        out.title = "Marxism–Leninism";
        out.desc =
          "You qualified for the Marxism–Leninism layer in the quiz’s branching logic but did not enter the MLM sub-branch.";
        out.ideologyImg = "img/ml.png";
        out.ideologyAlt = "Marxism–Leninism symbol";
        out.layerNote = "Marx gate → tilt → Lenin gate";
        return out;
      }

      // Other Marx branches
      if (f && f.authMarx === true) {
        out.key = "authMarx";
        out.title = "Authoritarian-leaning Marxism";
        out.desc = "You met Marx eligibility and leaned toward centralized revolutionary authority.";
        out.ideologyImg = "img/marx-auth.png";
        out.ideologyAlt = "Authoritarian-leaning Marxism";
        out.layerNote = "Marx gate → tilt";
        return out;
      }

      if (f && f.authMarx === false) {
        out.key = "demoMarx";
        out.title = "Democratic / pluralist-leaning Marxism";
        out.desc = "You met Marx eligibility while leaning toward pluralism within socialist transformation.";
        out.ideologyImg = "img/marx-dem.png";
        out.ideologyAlt = "Democratic Marxism";
        out.layerNote = "Marx gate → tilt";
        return out;
      }

      if (f && f.marxEligible) {
        out.key = "marx";
        out.title = "Marxism (general)";
        out.desc = "You met the basic criteria for Marxist analysis but did not enter a doctrinal sub-branch.";
        out.ideologyImg = "img/marx.png";
        out.ideologyAlt = "Marxism symbol";
        out.layerNote = "Marx gate";
        return out;
      }

      return out;
    }

    // ----------------------------
    // Apply branch content to UI
    // ----------------------------
    const branch = determineBranch(flags);

    const titleEl = document.getElementById("branch-title");
    const descEl  = document.getElementById("branch-desc");
    const layerEl = document.getElementById("layer-note");

    titleEl.textContent = branch.title;
    descEl.textContent = branch.desc;
    layerEl.textContent = branch.layerNote;

    // ideology image: if missing, fallback to icon.png (DO NOT HIDE)
    const ideologyImg = document.getElementById("ideology-img");
    ideologyImg.alt = branch.ideologyAlt || branch.title;
    ideologyImg.onerror = function () {
      this.onerror = null;
      this.src = "icon.png";
    };
    ideologyImg.src = branch.ideologyImg || "icon.png";

    // figure: show/hide cleanly
    const figureCard = document.getElementById("figure-card");
    const figureImg = document.getElementById("figure-img");

    if (!branch.figureName && !branch.figureDesc) {
      figureCard.style.display = "none";
    } else {
      figureCard.style.display = "grid";
      document.getElementById("figure-name").textContent = branch.figureName || "";
      document.getElementById("figure-desc").textContent = branch.figureDesc || "";

      figureImg.alt = branch.figureAlt || branch.figureName || "Figure";
      figureImg.onerror = function () {
        this.onerror = null;
        this.src = "icon.png";
      };
      figureImg.src = branch.figureImg || "icon.png";
    }

    // ----------------------------
    // Render axes
    // ----------------------------
    const root = document.getElementById("axes-results");
    const axesOk = (typeof AXES !== "undefined" && Array.isArray(AXES) && AXES.length > 0);

    if (!axesOk) {
      root.innerHTML = "<p style='text-align:center;'>AXES not loaded. Make sure axes.js exists and is linked.</p>";
    } else {
      root.innerHTML = AXES.map(axisBlock).join("");
    }
  </script>

  <style>
    /* Beautified results cards */
    :root{
      --iv-bg: rgba(0,0,0,0.22);
      --iv-border: rgba(255,255,255,0.12);
      --iv-soft: rgba(255,255,255,0.06);
      --iv-text: rgba(255,255,255,0.92);
      --iv-sub: rgba(255,255,255,0.78);
    }

    .iv-card{
      max-width: 980px;
      margin: 18px auto;
      border: 1px solid var(--iv-border);
      background: var(--iv-bg);
      border-radius: 18px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }

    .iv-hero{
      display: grid;
      grid-template-columns: 320px 1fr;
    }
    @media (max-width: 860px){
      .iv-hero{ grid-template-columns: 1fr; }
    }

    .iv-hero__media{
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 18px;
      background: rgba(0,0,0,0.30);
      border-right: 1px solid var(--iv-border);
      min-height: 220px;
    }
    @media (max-width: 860px){
      .iv-hero__media{ border-right:none; border-bottom:1px solid var(--iv-border); }
    }

    .iv-logo{
      width: 100%;
      height: 220px;
      object-fit: contain !important;
      background: rgba(0,0,0,0.18);
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: 14px;
      padding: 12px;
    }

    .iv-hero__content{ padding: 18px 20px; }

    .iv-kicker{
      font-size: 12px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      opacity: 0.8;
      margin-bottom: 8px;
    }

    .iv-title{
      margin: 0 0 10px 0;
      font-size: 24px;
      line-height: 1.2;
      color: var(--iv-text);
    }

    .iv-subtitle{
      margin: 0 0 8px 0;
      font-size: 20px;
      line-height: 1.25;
      color: var(--iv-text);
    }

    .iv-desc{
      margin: 0;
      color: var(--iv-sub);
      line-height: 1.55;
      font-size: 15.5px;
    }

    .iv-meta{
      margin-top: 14px;
      display:flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .iv-pill{
      border: 1px solid var(--iv-border);
      background: var(--iv-soft);
      border-radius: 999px;
      padding: 10px 12px;
      font-size: 13.5px;
      color: var(--iv-sub);
      display:flex;
      gap: 8px;
      align-items:center;
    }
    .iv-pill b{ color: var(--iv-text); font-weight: 700; }

    .iv-figure{
      display:grid;
      grid-template-columns: 220px 1fr;
    }
    @media (max-width: 860px){
      .iv-figure{ grid-template-columns: 1fr; }
    }

    .iv-figure__media{
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 16px;
      background: rgba(0,0,0,0.30);
      border-right: 1px solid var(--iv-border);
      min-height: 220px;
    }
    @media (max-width: 860px){
      .iv-figure__media{ border-right:none; border-bottom:1px solid var(--iv-border); }
    }

    .iv-figure__media img{
      width: 100%;
      height: 220px;
      object-fit: cover;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.18);
    }

    .iv-figure__content{ padding: 18px 20px; }

    /* Axes styling */
    .axis { margin: 18px auto; max-width: 980px; }
    .axis-title { font-weight: 700; margin-bottom: 8px; }
    .bar { display:flex; height:18px; border-radius:10px; overflow:hidden; background:#eee; }
    .bar-left { background:#444; }
    .bar-right { background:#999; }
    .axis-labels { display:flex; justify-content:space-between; margin-top:6px; font-size:14px; }
  </style>

</body>
</html>
