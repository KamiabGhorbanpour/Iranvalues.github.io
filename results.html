<!DOCTYPE html>
<html>
<head>
  <link href="https://fonts.googleapis.com/css?family=Montserrat:300,400,700|Roboto:400,700" rel="stylesheet">
  <link href="style.css" rel="stylesheet" type="text/css">
  <title>Iranvalues Results</title>
  <link rel="icon" type="x-icon" href="icon.png">
  <link rel="shortcut icon" type="x-icon" href="icon.png">
  <meta charset="utf-8">
</head>

<body>
  <h1>Iranvalues</h1>
  <hr>
  <h2 style="text-align:center;">Your Results</h2>

  <!-- DOCTRINAL RESULT BLOCK -->
  <div class="explanation_bg" style="margin-top: 20px;">
    <div class="spacer">
      <h2 style="text-align:center;">Doctrinal Result</h2>

      <p id="branch-title" style="text-align:center; font-size: 15pt; margin-bottom: 6px;"></p>
      <p id="branch-desc" style="text-align:center; opacity: 0.9; margin-top: 0;"></p>

      <p id="branch-method"
         style="text-align:center; opacity: 0.8; font-size: 11.5pt; margin-top: 10px; line-height: 1.35;">
        Method note: This label is determined via <b>multi-layer branching</b> (gated question sets).
        You first qualify for Marx-related questions, then a tilt layer, then Lenin-related questions, and finally MLM.
        Passing deeper layers implies you passed earlier layers, so you may “qualify” for several layers, but your displayed label
        reflects the <b>deepest layer reached</b>.
      </p>

      <p id="scores-debug" style="text-align:center; opacity: 0.65; font-size: 10.5pt; margin-top: 10px;"></p>
    </div>
  </div>

  <!-- AXIS RESULTS -->
  <div id="axes-results"></div>

  <p style="text-align:center; margin-top: 24px;">
    <a href="index.html">Take the quiz again</a>
  </p>

  <!-- Load axes definition -->
  <script src="axes.js"></script>

  <script>
    /* ============================
       READ STORED DATA
       ============================ */

    const scoresRaw = localStorage.getItem("scores");
    const scores = (() => {
      try { return JSON.parse(scoresRaw || "{}"); }
      catch (e) { return {}; }
    })();

    const flags = (() => {
      try { return JSON.parse(localStorage.getItem("flags")) || {}; }
      catch (e) { return {}; }
    })();

    /* ============================
       HELPERS
       ============================ */

    // IMPORTANT FIX:
    // LocalStorage often contains numbers as strings. parseFloat handles both.
    function num(x) {
      const n = parseFloat(x);
      return Number.isFinite(n) ? n : 0;
    }

    function rightPercent(leftKey, rightKey) {
      const L = num(scores[leftKey]);
      const R = num(scores[rightKey]);

      const denom = Math.abs(L) + Math.abs(R);
      if (denom === 0) return 50;

      const rpct = (Math.abs(R) / denom) * 100;

      // Direction correction:
      const diff = R - L;
      if (diff < 0) return 100 - rpct;
      return rpct;
    }

    function axisBlock(axis) {
      const r = rightPercent(axis.leftKey, axis.rightKey);
      const l = 100 - r;

      return `
        <div class="axis">
          <div class="axis-title">${axis.title}</div>
          <div class="bar">
            <div class="bar-left" style="width:${l}%"></div>
            <div class="bar-right" style="width:${r}%"></div>
          </div>
          <div class="axis-labels">
            <span>${axis.leftLabel} (${l.toFixed(0)}%)</span>
            <span>${axis.rightLabel} (${r.toFixed(0)}%)</span>
          </div>
        </div>
      `;
    }

    /* ============================
       DOCTRINAL BRANCH LOGIC
       ============================ */

    function determineBranch(flagsObj) {
      if (!flagsObj || typeof flagsObj !== "object") {
        return { title: "Axis-based result only", desc: "Your result is based solely on value axes." };
      }

      if (flagsObj.mlmQualified) {
        return {
          title: "Marxism–Leninism–Maoism (MLM)",
          desc: "You reached the deepest doctrinal layer in this quiz’s branching sequence."
        };
      }

      if (flagsObj.leninistEligible) {
        return {
          title: "Leninist Marxism",
          desc: "You qualified for the Leninist layer (party-centralist criteria), but not the MLM layer."
        };
      }

      if (flagsObj.authMarx === true) {
        return {
          title: "Authoritarian-leaning Marxism",
          desc: "You qualified for Marxism and tilted toward centralized revolutionary cohesion."
        };
      }

      if (flagsObj.authMarx === false) {
        return {
          title: "Democratic / pluralist Marxism",
          desc: "You qualified for Marxism and tilted toward pluralism within socialist transformation."
        };
      }

      if (flagsObj.marxEligible) {
        return {
          title: "Marxism (general)",
          desc: "You qualified for Marx-related questions but did not enter a doctrinal sub-branch."
        };
      }

      return {
        title: "Axis-based result only",
        desc: "You did not enter any doctrinal branch."
      };
    }

    /* ============================
       RENDER DOCTRINAL RESULT
       ============================ */

    const branch = determineBranch(flags);
    document.getElementById("branch-title").textContent = branch.title;
    document.getElementById("branch-desc").textContent = branch.desc;

    /* ============================
       RENDER AXES
       ============================ */

    const root = document.getElementById("axes-results");
    if (typeof AXES === "undefined") {
      root.innerHTML = "<p style='text-align:center;'>AXES not loaded. Make sure axes.js exists and is linked.</p>";
    } else {
      root.innerHTML = AXES.map(axisBlock).join("");
    }

    /* ============================
       TINY DEBUG LINE (optional)
       ============================ */

    const dbg = document.getElementById("scores-debug");
    if (dbg) {
      const keys = scores && typeof scores === "object" ? Object.keys(scores) : [];
      dbg.textContent = keys.length
        ? ("Axis data loaded (" + keys.length + " score keys found).")
        : "Axis data missing or empty (no score keys found) — check that the quiz writes localStorage.scores.";
    }
  </script>

  <!-- Minimal fallback styling -->
  <style>
    .axis { margin: 18px 0; }
    .axis-title { font-weight: 700; margin-bottom: 8px; }
    .bar { display:flex; height:18px; border-radius:10px; overflow:hidden; background:#eee; }
    .bar-left { background:#444; }
    .bar-right { background:#999; }
    .axis-labels { display:flex; justify-content:space-between; margin-top:6px; font-size:14px; }
  </style>

</body>
</html>
